<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Theme Manager Tests</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .pass { color: green; }
        .fail { color: red; font-weight: bold; }
        .test-group { margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        h2 { margin-top: 0; }
        .summary { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; padding: 10px; border-radius: 5px; }
        .summary.success { background: #d4edda; color: #155724; }
        .summary.failure { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Theme Manager Test Suite</h1>
    <div id="summary-container"></div>
    <div id="results"></div>

    <!-- Mocks and Setup -->
    <script>
        // Mock localStorage
        const localStorageMock = (function() {
            let store = {};
            return {
                getItem: function(key) {
                    return store[key] || null;
                },
                setItem: function(key, value) {
                    store[key] = value.toString();
                },
                clear: function() {
                    store = {};
                },
                removeItem: function(key) {
                    delete store[key];
                }
            };
        })();
        
        Object.defineProperty(window, 'localStorage', {
            value: localStorageMock
        });

        // Mock matchMedia
        window.matchMedia = window.matchMedia || function() {
            return {
                matches: false,
                addListener: function() {},
                removeListener: function() {},
                addEventListener: function() {},
                removeEventListener: function() {}
            };
        };
    </script>

    <!-- Load the module under test -->
    <script src="../js/theme.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/autoLocation.js"></script>
    
    <!-- Load test definitions -->
    <script src="theme.test.js"></script>
    <script src="auto-location.test.js"></script>

    <!-- Test Logic -->
    <script>
        const resultsDiv = document.getElementById('results');
        const summaryDiv = document.getElementById('summary-container');
        let testsPassed = 0;
        let testsFailed = 0;

        function describe(name, fn) {
            const group = document.createElement('div');
            group.className = 'test-group';
            group.innerHTML = `<h2>${name}</h2>`;
            resultsDiv.appendChild(group);
            
            try {
                // Execute the describe block immediately
                fn();
            } catch (e) {
                const error = document.createElement('div');
                error.className = 'fail';
                error.textContent = `Suite Error: ${e.message}`;
                group.appendChild(error);
                console.error(e);
            }
        }

        function it(name, fn) {
            // Find the last added group (current describe block)
            const groups = document.querySelectorAll('.test-group');
            const currentGroup = groups[groups.length - 1];
            
            const div = document.createElement('div');
            try {
                fn();
                div.className = 'pass';
                div.textContent = `✔ ${name}`;
                testsPassed++;
            } catch (e) {
                div.className = 'fail';
                div.textContent = `✘ ${name}: ${e.message}`;
                testsFailed++;
                console.error(e);
            }
            if (currentGroup) {
                currentGroup.appendChild(div);
            } else {
                resultsDiv.appendChild(div);
            }
        }

        function expect(actual) {
            return {
                toBe: (expected) => {
                    if (actual !== expected) {
                        throw new Error(`Expected ${expected}, but got ${actual}`);
                    }
                },
                toBeTruthy: () => {
                    if (!actual) throw new Error(`Expected truthy, but got ${actual}`);
                },
                toBeFalsy: () => {
                    if (actual) throw new Error(`Expected falsy, but got ${actual}`);
                }
            };
        }

        // Run Tests
        window.onload = function() {
            if (window.runThemeTests) {
                window.runThemeTests(describe, it, expect);
                
                // Render summary
                const summary = document.createElement('div');
                summary.className = testsFailed === 0 ? 'summary success' : 'summary failure';
                summary.textContent = `Summary: ${testsPassed} Passed, ${testsFailed} Failed`;
                summaryDiv.appendChild(summary);
            } else {
                summaryDiv.textContent = "Error: Test suite not loaded!";
                summaryDiv.className = "summary failure";
            }
        };
    </script>
</body>
</html>