<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="page_title_profile">ClosetTwin | Profile</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auto-location.css">
</head>    
    <style>
        /* Styles moved to css/style.css */
    </style>
</head>
<body>

    <div class="profile-header">
        <button class="edit-btn" onclick="openEditModal()" data-i18n="edit">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
        <img src="images/default_avatar.svg" class="profile-avatar" alt="Profile Avatar">
        <h2 class="profile-name" id="display-name">User</h2>
        <p class="profile-role" data-i18n="user_role">Fashion Enthusiast</p>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title" data-i18n="edit_profile_title">Edit Profile</div>
            
            <div class="form-group">
                <label class="form-label" data-i18n="label_name">Name</label>
                <input type="text" class="form-input" id="edit-name" value="User">
            </div>
            
            <div class="form-group">
                <label class="form-label" data-i18n="label_avatar">Avatar</label>
                <div class="avatar-upload-container">
                    <img id="edit-avatar-preview" src="" class="profile-avatar avatar-preview-lg" onclick="document.getElementById('edit-avatar-input').click()">
                    <input type="file" id="edit-avatar-input" accept="image/*" onchange="previewAvatar(this)" hidden>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('edit-avatar-input').click()" data-i18n="btn_choose_image">Choose Image</button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeEditModal()" data-i18n="btn_cancel">Cancel</button>
                <button class="btn btn-save" onclick="saveProfile()" data-i18n="btn_save">Save</button>
            </div>
        </div>
    </div>

    <div class="menu-list">
        <div class="menu-item" onclick="openRegionModal()">
            <span data-i18n="menu_region">Region</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="text-sub" id="current-region" style="font-size: 13px;" data-i18n="detecting_location">定位中...</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
        </div>
        <div class="menu-item" onclick="openProfessionModal()">
            <span data-i18n="menu_profession">Profession</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="text-sub" id="current-profession" style="font-size: 13px;">Fashion Enthusiast</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
        </div>
        <div class="menu-item" onclick="openSettingsModal()">
            <span data-i18n="menu_settings">Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </div>
    </div>

    <!-- Region Modal -->
    <div class="modal-overlay" id="region-modal">
        <div class="modal-content" style="height: 80vh; max-height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="header_region">Select Region</div>
                <button class="close-btn" onclick="closeRegionModal()">×</button>
            </div>
            
            <div class="search-container" style="margin-bottom: 16px; background: transparent; padding: 0; border: none;">
                <input type="text" class="form-input" id="region-search" data-i18n-placeholder="placeholder_search_region" placeholder="Search region..." oninput="filterRegions(this.value)">
            </div>
            
            <div style="margin-bottom: 16px;">
                <div id="auto-location-btn" class="menu-item auto-location-item" onclick="handleAutoLocation()">
                    <div class="auto-location-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="auto-location-icon">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                        </svg>
                        <span data-i18n="auto_detect_location">Auto Detect Location</span>
                    </div>
                    <div class="auto-location-right" id="auto-location-status">
                        <!-- Status injected via JS -->
                    </div>
                </div>
            </div>

            <div class="isolated-scroll" id="region-list" style="flex: 1;">
                <!-- Regions will be populated here -->
            </div>
        </div>
    </div>

    <!-- Profession Modal -->
    <div class="modal-overlay" id="profession-modal">
        <div class="modal-content" style="height: 80vh; max-height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="header_profession">Select Profession</div>
                <button class="close-btn" onclick="closeProfessionModal()">×</button>
            </div>
            
            <div class="search-container" style="margin-bottom: 16px; background: transparent; padding: 0; border: none;">
                <input type="text" class="form-input" id="profession-search" data-i18n-placeholder="placeholder_search_profession" placeholder="Search profession..." oninput="filterProfessions(this.value)">
            </div>
            
            <div class="isolated-scroll" id="profession-list" style="flex: 1;">
                <!-- Professions will be populated here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title" data-i18n="header_settings">Settings</div>
            
            <div class="form-group">
                <div class="form-label form-label-mb" data-i18n="lang_switch_label">Language</div>
                <div class="theme-selector">
                    <label class="theme-option">
                        <input type="radio" name="language" value="en" onchange="window.i18n.setLanguage('en')">
                        <span class="theme-label">English</span>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="language" value="zh-CN" onchange="window.i18n.setLanguage('zh-CN')">
                        <span class="theme-label">中文</span>
                    </label>
                    <div class="theme-slider"></div>
                </div>
            </div>
            
            <div class="form-group form-section-divider">
                <div class="form-label form-label-mb" data-i18n="settings_appearance">Appearance</div>
                <div class="theme-selector">
                    <label class="theme-option">
                        <input type="radio" name="theme" value="light">
                        <span class="theme-label" data-i18n="theme_light">Light</span>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="theme" value="dark">
                        <span class="theme-label" data-i18n="theme_dark">Dark</span>
                    </label>
                    <label class="theme-option">
                        <input type="radio" name="theme" value="system">
                        <span class="theme-label" data-i18n="theme_system">System</span>
                    </label>
                    <div class="theme-slider"></div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="logout-btn" onclick="logout()" data-i18n="btn_sign_out">Sign Out</button>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeSettingsModal()" data-i18n="btn_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span data-i18n="nav_home">Home</span>
        </a>
        <a href="wardrobe.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"></path></svg>
            <span data-i18n="nav_wardrobe">Wardrobe</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span data-i18n="nav_profile">Profile</span>
        </a>
    </nav>

    <!-- Scripts -->
    <script src="js/i18n.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/autoLocation.js"></script>
    <script src="js/app.js"></script>
    <script>
        async function handleAutoLocation() {
            const btn = document.getElementById('auto-location-btn');
            const statusEl = document.getElementById('auto-location-status');
            
            // 1. Set Loading State
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                btn.classList.add('auto-location-loading');
                statusEl.innerHTML = ''; // Clear previous status
            } else {
                // PC: Spinner
                statusEl.innerHTML = `<div class="spinner"></div> <span data-i18n="detecting_location">${window.i18n.get('detecting_location') || 'Detecting...'}</span>`;
            }
            
            try {
                // 2. Call Service
                const location = await window.autoLocationService.detectLocation();
                
                // 3. Success UI
                btn.classList.remove('auto-location-loading');
                
                // Use unified translation function
                let locationText = window.autoLocationService.translateAutoSelect(location);
                
                const prefix = ''; // Removed "Located: "
                
                // Store the raw text for fallback, but ideally use regionKey if available for translation
                const dynamicSpan = document.createElement('span');
                dynamicSpan.className = 'location-highlight';
                dynamicSpan.setAttribute('data-i18n-dynamic', 'true');
                dynamicSpan.setAttribute('data-prefix-key', '');
                dynamicSpan.setAttribute('data-location-text', locationText);
                
                // If we have a regionKey (even from auto-detect), use it for better translation
                if (location.regionKey && location.regionKey !== 'region_unknown') {
                     dynamicSpan.setAttribute('data-region-key', location.regionKey);
                }
                
                dynamicSpan.innerHTML = `${prefix}${locationText}`;
                statusEl.innerHTML = '';
                statusEl.appendChild(dynamicSpan);
                
                // Update Main Profile UI
                document.getElementById('current-region').textContent = locationText; // Use translated text
                document.getElementById('current-region').setAttribute('data-i18n', location.regionKey);
                
                // Update LocalStorage
                let user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                user.regionKey = location.regionKey;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
            } catch (error) {
                // 4. Error UI
                btn.classList.remove('auto-location-loading');
                const errorText = window.i18n.get('location_failed') || 'Location failed, please select manually';
                statusEl.innerHTML = `<span class="location-error">${errorText}</span>`;
                
                // Expand manual selection (ensure it is visible)
                const regionList = document.getElementById('region-list');
                if (regionList.style.display === 'none') {
                    regionList.style.display = 'block';
                }
            }
        }

        // Sample Data with Keys for Translation
        const regions = [
            { key: "region_new_york", label: "New York" },
            { key: "region_london", label: "London" },
            { key: "region_paris", label: "Paris" },
            { key: "region_tokyo", label: "Tokyo" },
            { key: "region_shanghai", label: "Shanghai" },
            { key: "region_beijing", label: "Beijing" },
            { key: "region_hong_kong", label: "Hong Kong" },
            { key: "region_singapore", label: "Singapore" },
            { key: "region_sydney", label: "Sydney" },
            { key: "region_los_angeles", label: "Los Angeles" },
            { key: "region_chicago", label: "Chicago" },
            { key: "region_toronto", label: "Toronto" },
            { key: "region_berlin", label: "Berlin" },
            { key: "region_milan", label: "Milan" },
            { key: "region_seoul", label: "Seoul" },
            { key: "region_bangkok", label: "Bangkok" },
            { key: "region_dubai", label: "Dubai" },
            { key: "region_mumbai", label: "Mumbai" }
        ];
        
        const professions = [
            { key: "profession_fashion_enthusiast", label: "Fashion Enthusiast" },
            { key: "profession_student", label: "Student" },
            { key: "profession_teacher", label: "Teacher" },
            { key: "profession_programmer", label: "Programmer" },
            { key: "profession_designer", label: "Designer" },
            { key: "profession_model", label: "Model" },
            { key: "profession_blogger", label: "Blogger" },
            { key: "profession_stylist", label: "Stylist" },
            { key: "profession_photographer", label: "Photographer" },
            { key: "profession_editor", label: "Editor" },
            { key: "profession_artist", label: "Artist" },
            { key: "profession_musician", label: "Musician" },
            { key: "profession_actor", label: "Actor" },
            { key: "profession_writer", label: "Writer" },
            { key: "profession_doctor", label: "Doctor" },
            { key: "profession_lawyer", label: "Lawyer" },
            { key: "profession_engineer", label: "Engineer" },
            { key: "profession_architect", label: "Architect" },
            { key: "profession_chef", label: "Chef" },
            { key: "profession_other", label: "Other" }
        ];

        // --- Region Logic ---
        function openRegionModal() {
            const modal = document.getElementById('region-modal');
            activateOverlay(modal, modal.querySelector('.modal-content'));
            renderList('region-list', regions, selectRegion);
        }

        function closeRegionModal() {
            deactivateOverlay(document.getElementById('region-modal'));
        }

        function filterRegions(query) {
            const lang = window.i18n.locale;
            const filtered = regions.filter(r => {
                const text = window.i18n.get(r.key) || r.label;
                return text.toLowerCase().includes(query.toLowerCase());
            });
            renderList('region-list', filtered, selectRegion);
        }

        function selectRegion(regionItem) {
            // Update UI
            const regionName = window.i18n.get(regionItem.key) || regionItem.label;
            document.getElementById('current-region').textContent = regionName;
            document.getElementById('current-region').setAttribute('data-i18n', regionItem.key);
            
            // Simulate Backend Call
            console.log(`[Backend Sync] User region updated to: ${regionItem.key}`);
            
            // Save to LocalStorage
            let user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            user.regionKey = regionItem.key; // Save key instead of text
            localStorage.setItem('currentUser', JSON.stringify(user));

            closeRegionModal();
        }

        // --- Profession Logic ---
        function openProfessionModal() {
            const modal = document.getElementById('profession-modal');
            activateOverlay(modal, modal.querySelector('.modal-content'));
            renderList('profession-list', professions, selectProfession);
        }

        function closeProfessionModal() {
            deactivateOverlay(document.getElementById('profession-modal'));
        }

        function filterProfessions(query) {
            const filtered = professions.filter(p => {
                const text = window.i18n.get(p.key) || p.label;
                return text.toLowerCase().includes(query.toLowerCase());
            });
            renderList('profession-list', filtered, selectProfession);
        }

        function selectProfession(professionItem) {
            // Update UI
            const professionName = window.i18n.get(professionItem.key) || professionItem.label;
            document.getElementById('current-profession').textContent = professionName;
            document.getElementById('current-profession').setAttribute('data-i18n', professionItem.key);
            
            const profileRole = document.querySelector('.profile-role');
            profileRole.textContent = professionName;
            profileRole.setAttribute('data-i18n', professionItem.key);
            
            // Save to LocalStorage
            let user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            user.roleKey = professionItem.key; // Save key
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            closeProfessionModal();
        }

        // --- Helper: Render List ---
        function renderList(containerId, items, clickHandler) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item'; // Reuse menu-item style
                div.style.padding = '16px 0';
                div.style.borderBottom = '1px solid var(--border-color)';
                
                // Get translated text
                div.textContent = window.i18n.get(item.key) || item.label;
                
                div.onclick = () => clickHandler(item);
                container.appendChild(div);
            });
            
            if (items.length === 0) {
                const noResultsText = window.i18n.get('msg_no_results') || 'No results found';
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-sub);">${noResultsText}</div>`;
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const initProfile = () => {
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const regionEl = document.getElementById('current-region');
                
                // 1. Check User Preference for initial render (Fast Paint)
                // The global auto-location service in app.js will handle the actual detection and update if needed.
                // Here we just set the initial state based on what we have.
                if (user.regionKey) {
                      if (user.regionKey !== 'auto_detect_pending') {
                          regionEl.setAttribute('data-i18n', user.regionKey);
                          // Translate immediately if i18n is ready
                          if (window.i18n && window.i18n.loaded) {
                              regionEl.textContent = window.i18n.get(user.regionKey);
                          }

                          // If it's a known key, i18n.js will translate it.
                          // Check cache for custom keys text
                          const cached = window.autoLocationService.getCachedLocation();
                          if (cached && cached.regionKey === user.regionKey) {
                              const locationText = window.autoLocationService.translateAutoSelect(cached);
                              regionEl.textContent = locationText;
                          }
                     } else {
                         // Pending state, let global service handle it
                         regionEl.setAttribute('data-i18n', 'detecting_location');
                         if (window.i18n && window.i18n.loaded) {
                             regionEl.textContent = window.i18n.get('detecting_location');
                         }
                     }
                 } else if (user.region) {
                     // Fallback for legacy text data
                     regionEl.textContent = user.region;
                 } else {
                     // No preference, default to auto (Global service will trigger)
                     regionEl.setAttribute('data-i18n', 'detecting_location');
                     if (window.i18n && window.i18n.loaded) {
                         regionEl.textContent = window.i18n.get('detecting_location');
                     }
                 }
                 
                 if (user.roleKey) {
                     const elRole = document.getElementById('current-profession');
                     const elHeaderRole = document.querySelector('.profile-role');
                     
                     elRole.setAttribute('data-i18n', user.roleKey);
                     elHeaderRole.setAttribute('data-i18n', user.roleKey);
                     
                     if (window.i18n && window.i18n.loaded) {
                         elRole.textContent = window.i18n.get(user.roleKey);
                         elHeaderRole.textContent = window.i18n.get(user.roleKey);
                     }
                 } else if (user.role) {
                    // Fallback
                    document.getElementById('current-profession').textContent = user.role;
                    document.querySelector('.profile-role').textContent = user.role;
                }
            };

            if (window.i18n && window.i18n.loaded) {
                initProfile();
            } else {
                window.addEventListener('i18nReady', initProfile, { once: true });
            }
        });


        function openEditModal() {
            const currentName = document.getElementById('display-name').innerText;
            const currentAvatar = document.querySelector('.profile-header .profile-avatar').src;
            
            document.getElementById('edit-name').value = currentName;
            document.getElementById('edit-avatar-preview').src = currentAvatar;
            document.getElementById('edit-avatar-input').value = ''; // Reset file input
            
            const editModal = document.getElementById('edit-modal');
            const editContent = editModal ? editModal.querySelector('.modal-content') : null;
            activateOverlay(editModal, editContent);
        }

        function closeEditModal() {
            const editModal = document.getElementById('edit-modal');
            deactivateOverlay(editModal);
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-avatar-preview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const newName = document.getElementById('edit-name').value;
            const avatarPreviewSrc = document.getElementById('edit-avatar-preview').src;
            
            if (newName.trim() === '') {
                // alert(window.i18n.get('msg_name_required'));
                if (window.showToast) {
                    showToast(window.i18n.get('msg_name_required') || 'Name is required');
                } else {
                    alert(window.i18n.get('msg_name_required') || 'Name is required');
                }
                return;
            }

            // Update UI
            document.getElementById('display-name').innerText = newName;
            document.querySelector('.profile-header .profile-avatar').src = avatarPreviewSrc;
            
            // Update localStorage
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                const user = JSON.parse(userStr);
                user.name = newName;
                user.avatar = avatarPreviewSrc; // Save avatar data
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Also update the user in the 'users' array if needed for login consistency
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.email === user.email);
                if (userIndex !== -1) {
                    users[userIndex].name = newName;
                    users[userIndex].avatar = avatarPreviewSrc; // Save avatar data
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }

            closeEditModal();
            alert(window.i18n.get('msg_profile_updated'));
        }

        // Close modal when clicking outside
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Settings Modal Logic
        function openSettingsModal() {
            const settingsModal = document.getElementById('settings-modal');
            const settingsContent = settingsModal ? settingsModal.querySelector('.modal-content') : null;
            activateOverlay(settingsModal, settingsContent);
            
            // Force update sliders when modal opens
            // Use small delay to allow display:block to take effect
            setTimeout(() => {
                if (window.themeManager) {
                    window.themeManager.updateAllSliders();
                }
            }, 50);
        }

        function closeSettingsModal() {
            const settingsModal = document.getElementById('settings-modal');
            deactivateOverlay(settingsModal);
        }

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });
    </script>
</body>
</html>
